"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[503],{60503:function(e,t,n){n.d(t,{U:function(){return E},Z:function(){return b}});var i=n(35944),a=n(67294),l=n(47041),o=n(56559),r=n(87278),c=n(33405),d=n(26835),s=e=>{let{open:t,onCancel:n,onConfirm:a}=e;return(0,i.tZ)(d.default,{open:t,title:"Delete highlight and comments?",content:(0,i.BX)("div",{children:[(0,i.BX)("p",{children:["Deleting the highlight also deletes all the comments associated with it.",(0,i.tZ)("br",{}),"Are you sure you want to proceed?"]}),(0,i.BX)("div",{className:"mt-10 flex justify-end gap-2",children:[(0,i.tZ)(c.Z,{variant:"outlined",color:"dark",onClick:n,children:"Cancel"}),(0,i.tZ)(c.Z,{variant:"contained",color:"danger",onClick:a,children:"Yes, delete"})]})]}),onClose:n})},u=n(98388),h=n(64954),g=e=>{let{showOnElementSelector:t}=e,n=(0,a.useRef)(null),{isMobile:l}=(0,a.useContext)(h.Tp),o=(0,a.useRef)({clientX:null,clientY:null}),[r,c]=(0,a.useState)(!1),d=(e,t)=>{n.current&&(n.current.style.left=t+5+"px",n.current.style.top=e-10+"px")},s=(e,n)=>{var i;(null===(i=document.elementFromPoint(e,n))||void 0===i?void 0:i.closest(t))?c(!0):c(!1)},g=e=>{try{if(!e||!n.current)return;let t=e.clientY-n.current.offsetHeight+window.scrollY,i=e.clientX;o.current={clientX:e.clientX,clientY:e.clientY},d(t,i),s(e.clientX,e.clientY)}catch(e){console.log("CursorTooltip onMouseMove",e)}},v=e=>{try{if(!e||!n.current||!o.current.clientX||!o.current.clientY)return;let t=o.current.clientY-n.current.offsetHeight+window.scrollY,i=o.current.clientX;d(t,i),s(o.current.clientX,o.current.clientY)}catch(e){console.log("CursorTooltip onScroll",e)}};return(0,a.useEffect)(()=>{if(window)return window.addEventListener("mousemove",g),window.addEventListener("scroll",v),()=>{window.removeEventListener("mousemove",g),window.removeEventListener("scroll",v)}},[]),(0,i.tZ)("div",{ref:n,style:{zIndex:9999999999},className:(0,u.m6)("max-lg:hidden absolute bg-yellow-300 px-2 rounded font-light text-sm",r&&"border border-solid border-warning-700"),children:r&&!l?(0,i.BX)(i.HY,{children:["Select a statement in the PDF to use Copilot",(0,i.tZ)("span",{className:"pointer-events-none absolute -left-5 top-4 h-7 w-7 rounded-full bg-yellow-500 opacity-50"})]}):null})},v=n(28508),f=n(9669),p=n.n(f);let _="/api/annotations";class m{async getHighlights(e,t){return(await p().get("".concat(_,"/highlights"),{withCredentials:!0,params:{entity_full_slug:e,entity_type:t}})).data}async getNotes(e,t){return(await p().get("".concat(_,"/notes"),{withCredentials:!0,params:{entity_full_slug:e,entity_type:t}})).data}async getMigratedNotes(e,t){return(await p().get("".concat(_,"/migrated-notebook"),{withCredentials:!0,params:{entity_full_slug:e,entity_type:t}})).data}async createHighlight(e){return(await p().post("".concat(_,"/highlights"),e,{withCredentials:!0})).data}async createNote(e){return(await p().post("".concat(_,"/notes"),e,{withCredentials:!0})).data}async updateHighlight(e,t){let n="".concat(_,"/highlights/").concat(e);return(await p().patch(n,t,{withCredentials:!0})).data}async updateNote(e,t){let n="".concat(_,"/notes/").concat(e);return(await p().patch(n,t,{withCredentials:!0})).data}async deleteHighlight(e){let t="".concat(_,"/highlights/").concat(e);return(await p().delete(t,{withCredentials:!0})).data}async deleteNote(e){let t="".concat(_,"/notes/").concat(e);return(await p().delete(t,{withCredentials:!0})).data}}let C=new m;var w=n(91575),y=n(77666);let E=a.createContext({highlights:{},selectedHighlightUniqueId:null,showSelectionTooltip:!1,notes:{},annotationSidebarType:null,annotationsFilter:{},entitySlug:"",entityType:"PAPER",selectedAnnotationId:null,genericNoteDefaultContent:"",showCursorText:!1,showNoteSavedSnackbar:!1,notesTransferedToNotebook:null,enabled:!0,addHighlightInstance:()=>{},executeHighlightAction:async()=>{},setShowSelectionTooltip:e=>{},executeNoteAction:()=>{},updateAnnotationsSidebarType:()=>{},setAnnotationsFilter:()=>{},locateAnnotationInList:()=>{},setHighlightPluginInstance:()=>{},locateHighlightInPdf:()=>{},updateSelectedAnnotationId:()=>{},changeShowCursorText:()=>{}});var b=e=>{let{children:t,entitySlug:n,entityType:c,enabled:d=!0}=e,{user:u}=(0,a.useContext)(o.Vo),{copilotUIState:f}=(0,a.useContext)(r.C),{isMobile:p}=(0,a.useContext)(h.Tp),_=(0,a.useRef)({}),m=(0,a.useRef)(null),b=(0,a.useRef)(null),[S,q]=(0,a.useState)(!1),[N,x]=(0,a.useState)(null),[T,H]=(0,a.useState)(null),[R,A]=(0,a.useState)(!1),[L,O]=(0,a.useState)(null),[I,P]=(0,a.useState)({}),[Z,D]=(0,a.useState)({}),[k,X]=(0,a.useState)({}),[Y,M]=(0,a.useState)(null),[j,U]=(0,a.useState)(""),[B,G]=(0,a.useState)(!1),[F,W]=(0,a.useState)(!1),[V,z]=(0,a.useState)(null),Q=e=>{M(e)},J=async e=>{Object.values(_.current).map(e=>{e.removeAll()}),Object.values(e).forEach(async e=>{var t,n;let{startMeta:i,endMeta:a}=e.coordinates.simplifiedXpath;await (null===(t=_.current[e.coordinates.pageNumber])||void 0===t?void 0:t.fromStore(i,a,e.selected_text,e.unique_id,e.coordinates.xpath)),null===(n=_.current[e.coordinates.pageNumber])||void 0===n||n.addClass(y.e_.normalClasses[e.color_code],e.unique_id),Object.values(Z).find(t=>t.highlight_unique_id===e.unique_id)&&ec(e.unique_id)})},K=async()=>{if(n&&c&&u)try{q(!0);let[e,t,i]=await Promise.all([C.getHighlights(n,c),C.getNotes(n,c),C.getMigratedNotes(n,c)]);z(i.collection_record);let a={};e.data.forEach(e=>{a[e.unique_id]=e}),P(a);let l={};t.data.map(e=>{l[e.unique_id]=e}),D(l),J(a)}catch(e){console.log("Error while fetching annotations",e)}finally{q(!1)}},$=async e=>{let{highlightColorCode:t}=e,i=window.getSelection();if(i&&!i.isCollapsed){var a,l;let e=(0,y.pv)(),o=i.getRangeAt(0),r="#text"===o.commonAncestorContainer.nodeName?o.commonAncestorContainer.parentElement:o.commonAncestorContainer;if(!(null==r?void 0:null===(a=r.closest("[data-page-index]"))||void 0===a?void 0:a.dataset.pageIndex)||!_.current[e]){A(!1);return}let{id:d,text:s,startMeta:h,endMeta:g,extra:v}=_.current[e].fromRange(o),f=await (0,y.ey)(d),p={created_at:new Date().toString(),updated_at:new Date().toString(),created_by:{name:(null==u?void 0:u.full_name)||"",profile_pic:(null==u?void 0:u.profile_pic)||""},unique_id:d,selected_text:s,color_code:t,coordinates:{pageNumber:e,selectionOffset:f,simplifiedXpath:{startMeta:h,endMeta:g},xpath:v,selectionData:{selectedText:s}}};P({...I,[p.unique_id]:p}),_.current[e].addClass(y.e_.activeClasses[t],p.unique_id),O(p.unique_id),null===(l=document.getSelection())||void 0===l||l.removeAllRanges();try{q(!0);let i=await C.createHighlight({entity_type:c,entity_full_slug:n,selected_text:s,color_code:t,coordinates:{pageNumber:e,selectionOffset:f,simplifiedXpath:{startMeta:h,endMeta:g},xpath:v,selectionData:{selectedText:s}}});(0,w.Z)("highlight_added",{color:t,page:c}),Array.from(document.querySelectorAll('[data-highlight-id="'.concat(d,'"]'))).map(e=>e.dataset.highlightId=i.unique_id);let a={...I};delete a[p.unique_id],P({...a,[i.unique_id]:i}),_.current[e].addClass(y.e_.activeClasses[t],i.unique_id),O(i.unique_id)}catch(e){console.log("error while creating a highlight",e)}finally{q(!1)}}},ee=async e=>{var t,n;let{highlight_unique_id:i,highlightColorCode:a,added_via:l}=e,o=I[i];_.current[o.coordinates.pageNumber].removeClass(y.e_.activeClasses[null==o?void 0:o.color_code],o.unique_id),_.current[o.coordinates.pageNumber].addClass(y.e_.activeClasses[a],o.unique_id),P({...I,[o.unique_id]:{...o,color_code:a}});let r=y.e_.hexCodes[a];null===(n=document.querySelector('[data-noteicon-container-for="'.concat(i,'"]')))||void 0===n||null===(t=n.firstChild)||void 0===t||t.setAttribute("fill",r);try{o.color_code!==a&&(q(!0),await C.updateHighlight(i,{color_code:a}),(0,w.Z)("highlight_updated",{color:a,page:c,added_via:l}))}catch(e){console.log("error while changing the color of highlight",e)}finally{q(!1)}},et=e=>{let{highlight_unique_id:t}=e,n=I[t];Object.values(Z).findIndex(e=>e.highlight_unique_id===t)>-1&&(0,w.Z)("note_viewed",{viewed_via:"TOOLBAR",page:c}),Object.values(y.e_.normalClasses).forEach(e=>_.current[n.coordinates.pageNumber].removeClass(e,t)),_.current[n.coordinates.pageNumber].addClass(y.e_.activeClasses[n.color_code],t),O(t)},en=()=>{if(!L)return;let e=I[L];Object.values(y.e_.activeClasses).forEach(t=>_.current[e.coordinates.pageNumber].removeClass(t,L)),_.current[e.coordinates.pageNumber].addClass(y.e_.normalClasses[e.color_code],e.unique_id),O(null)},ei=async e=>{await ea(e);let t={...Z};Object.values(Z).filter(t=>t.highlight_unique_id===e).map(e=>{delete t[e.unique_id]}),ed(e),D({...t}),H(null)},ea=async e=>{let t=I[e];q(!0);try{let e=document.querySelectorAll('[data-highlight-id="'.concat(t.unique_id,'"]'))||[];await C.deleteHighlight(t.unique_id);let n=[];e.forEach(e=>{let t=e.dataset.highlightIdExtra;t&&n.push(t)}),n=Array.from(new Set(n));let i={...I};delete i[t.unique_id],P({...i}),O(null),A(!1),(0,w.Z)("highlight_deleted",{deleted_via:b.current,page:c}),_.current[t.coordinates.pageNumber].remove(t.unique_id),n.forEach(async e=>{if(e&&I[e]){let{coordinates:n,color_code:i}=I[e];await _.current[n.pageNumber].removeClass(y.e_.activeClasses[t.color_code],e),await _.current[n.pageNumber].addClass(y.e_.normalClasses[i],e)}})}catch(e){console.log("error while deleting a highlight",e)}finally{q(!1),b.current=null}},el=async e=>{let{highlight_unique_id:t,deleted_via:n}=e,i=I[t];if(b.current=n,Object.values(Z).filter(e=>e.highlight_unique_id===(null==i?void 0:i.unique_id)).length){H(t);return}await ea(t)},eo=async(e,t)=>{if(!S)switch(e){case"CREATE":$(t);break;case"SELECT":et(t);break;case"UNSELECT":en();break;case"UPDATE":ee(t);break;case"DELETE":await el(t)}},er=async e=>{let{highlight_unique_id:t,thread_unique_id:i,note_content:a,added_via:l,position:o=1}=e;q(!0);try{let e=await C.createNote({content:a,thread_unique_id:i||null,entity_full_slug:n,entity_type:c,highlight_unique_id:t||null});(0,w.Z)("note_added",{position:o,page:c,added_via:"DIRECT"===l?j?"COPILOT":"DIRECT":l}),j&&(W(!0),setTimeout(()=>W(!1),1e4)),D({...Z,[e.unique_id]:e}),t&&!i&&ec(t)}catch(e){console.log("error while creating a note",e)}finally{q(!1)}},ec=e=>{var t,n;let i=I[e],a=document.querySelector('[data-page-index="'.concat(i.coordinates.pageNumber,'"]')),l=null==a?void 0:a.clientHeight,o=null==a?void 0:a.clientWidth,r=!!document.querySelector('[data-noteicon-container-for="'.concat(e,'"]'));if(!l||!o||!i.coordinates.selectionOffset||r)return;let c=l*(null===(t=i.coordinates.selectionOffset)||void 0===t?void 0:t.top)/100-10,d=o*(null===(n=i.coordinates.selectionOffset)||void 0===n?void 0:n.left)/100-15,s=y.e_.hexCodes[i.color_code];a.innerHTML='<div style="position:absolute; top:'.concat(c,"px; left:").concat(d,'px; width:10px;" data-noteicon-container-for="').concat(e,'"><svg viewBox="0 0 9 11" fill="').concat(s,'" xmlns="http://www.w3.org/2000/svg"><path d="M2.34375 6.5H6.40625C6.66016 6.5 6.875 6.30469 6.875 6.03125C6.875 5.77734 6.66016 5.5625 6.40625 5.5625H2.34375C2.07031 5.5625 1.875 5.77734 1.875 6.03125C1.875 6.30469 2.07031 6.5 2.34375 6.5ZM2.34375 8.375H4.53125C4.78516 8.375 5 8.17969 5 7.90625C5 7.65234 4.78516 7.4375 4.53125 7.4375H2.34375C2.07031 7.4375 1.875 7.65234 1.875 7.90625C1.875 8.17969 2.07031 8.375 2.34375 8.375ZM2.34375 4.625H6.40625C6.66016 4.625 6.875 4.42969 6.875 4.15625C6.875 3.90234 6.66016 3.6875 6.40625 3.6875H2.34375C2.07031 3.6875 1.875 3.90234 1.875 4.15625C1.875 4.42969 2.07031 4.625 2.34375 4.625ZM7.5 0.25H1.25C0.546875 0.25 0 0.816406 0 1.5V9C0 9.70312 0.546875 10.25 1.25 10.25H7.5C8.18359 10.25 8.75 9.70312 8.75 9V1.5C8.75 0.816406 8.18359 0.25 7.5 0.25ZM7.8125 9C7.8125 9.17578 7.65625 9.3125 7.5 9.3125H1.25C1.07422 9.3125 0.9375 9.17578 0.9375 9V2.75H7.8125V9Z"/></svg></div>')+(null==a?void 0:a.innerHTML)},ed=e=>{var t;null===(t=document.querySelector('[data-noteicon-container-for="'.concat(e,'"]')))||void 0===t||t.remove()},es=async e=>{let{note_unique_id:t,deleted_via:n}=e,i=Z[t];q(!0);try{await C.deleteNote(t),(0,w.Z)("note_deleted",{deleted_via:n,page:c}),i.highlight_unique_id&&1===Object.values(Z).filter(e=>e.highlight_unique_id===i.highlight_unique_id).length&&ed(i.highlight_unique_id);let e={...Z};delete e[t],D({...e})}catch(e){console.log("error while deleting a note",e)}finally{q(!1)}},eu=async e=>{let{note_unique_id:t,note_content:n}=e;q(!0);try{await C.updateNote(t,{content:n}),D({...Z,[t]:{...Z[t],content:n}})}catch(e){console.log("error while updating a note",e)}finally{q(!1)}},eh=e=>{x("ADD_GENERIC_NOTE"),U(e.note_content)},eg=async(e,t)=>{if(!S)switch(e){case"CREATE":await er(t);break;case"CREATE_FROM_COPILOT":await eh(t);break;case"DELETE":await es(t);break;case"UPDATE":await eu(t)}};return(0,a.useEffect)(()=>{(0,l.getCookie)(v.TX)||G(!0),n&&u&&K()},[n,u]),(0,i.BX)(E.Provider,{value:{addHighlightInstance:(e,t)=>{_.current[t]=e,J(I)},executeHighlightAction:eo,highlights:I,selectedHighlightUniqueId:L,showSelectionTooltip:R,setShowSelectionTooltip:A,annotationSidebarType:N,updateAnnotationsSidebarType:(e,t)=>{x(e),N||U(""),t&&(0,w.Z)("note_sidebar_viewed",{viewed_via:t,page:c})},executeNoteAction:eg,notes:Z,setAnnotationsFilter:X,annotationsFilter:k,locateAnnotationInList:(e,t)=>{X({}),setTimeout(()=>{let n;let i=document.querySelector("[data-annotations-list]");if(!i)return;if("HIGHLIGHT"===t)n=document.querySelector('[data-annotation-id="'.concat(e,'"]')).closest("[data-filtered-annotation-id]");else{let t=Z[e].thread_unique_id;n=document.querySelector('[data-note-thread-id="'.concat(t,'"]')).closest("[data-filtered-annotation-id]")}if(!n)return;i.scrollTop=n.offsetTop-i.offsetTop;let a=n.dataset.filteredAnnotationId;a&&Q(a)},200)},setHighlightPluginInstance:e=>{m.current=e},locateHighlightInPdf:e=>{var t,n;let i=I[e];if(!m.current||!i)return;let{jumpToHighlightArea:a}=m.current;a({height:10,left:(null===(t=i.coordinates.selectionOffset)||void 0===t?void 0:t.left)||0,pageIndex:i.coordinates.pageNumber,top:(null===(n=i.coordinates.selectionOffset)||void 0===n?void 0:n.top)||0,width:10}),setTimeout(()=>{var e;null===(e=_.current[i.coordinates.pageNumber])||void 0===e||e.addClass("animate-blink",i.unique_id)},1500),setTimeout(()=>{var e;null===(e=_.current[i.coordinates.pageNumber])||void 0===e||e.removeClass("animate-blink",i.unique_id)},3500)},entitySlug:n,entityType:c,selectedAnnotationId:Y,updateSelectedAnnotationId:Q,genericNoteDefaultContent:j,changeShowCursorText:e=>{e&&!(0,l.getCookie)(v.TX)?G(!0):G(!1)},showCursorText:B,showNoteSavedSnackbar:F,notesTransferedToNotebook:V,enabled:!!d},children:[(0,i.tZ)(s,{open:!!T,onCancel:async()=>H(null),onConfirm:async()=>T&&ei(T)}),!p&&B&&"IS_SNIPPING"!==f&&(0,i.tZ)(g,{showOnElementSelector:"[data-highlightable]"}),t]})}},91575:function(e,t){t.Z=function(e){var t,n;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};null===(n=window)||void 0===n||null===(t=n.gtag)||void 0===t||t.call(n,"event",e,i)}},77666:function(e,t,n){n.d(t,{e_:function(){return a},ey:function(){return r},jQ:function(){return l},pv:function(){return o}});var i=n(91879);let a={colorList:["YELLOW","RED","PURPLE","GREEN"],normalClasses:{RED:"bg-highlight-red",YELLOW:"bg-highlight-yellow",GREEN:"bg-highlight-green",PURPLE:"bg-highlight-purple-500"},activeClasses:{RED:"bg-red-700",YELLOW:"bg-yellow-700",GREEN:"bg-green-700",PURPLE:"bg-purple-700"},annotationClasses:{RED:"bg-red-300",YELLOW:"bg-yellow-300",GREEN:"bg-green-300",PURPLE:"bg-purple-300"},hexCodes:{RED:"#F7A097",YELLOW:"#FFDA56",PURPLE:"#E58AE7",GREEN:"#9ED9A1"}},l=(e,t,n,a,l)=>{let o=new Range;o.setStart(e,t),o.setEnd(n,a);let{endOffset:r,end:c,startOffset:d,start:s}=(0,i.fromRange)(o,l.current);return{startMeta:{parentContainer:s,textOffset:d},endMeta:{parentContainer:c,textOffset:r}}},o=()=>{var e,t,n,i,a;return Number(null===(a=document.getSelection())||void 0===a?void 0:null===(i=a.anchorNode)||void 0===i?void 0:null===(n=i.parentElement)||void 0===n?void 0:null===(t=n.closest("[data-page-index]"))||void 0===t?void 0:null===(e=t.dataset)||void 0===e?void 0:e.pageIndex)},r=e=>{var t,n,i,a;let l=null===(t=document.querySelector('[data-highlight-id="'.concat(e,'"]')))||void 0===t?void 0:t.getBoundingClientRect(),o=null===(a=document.getSelection())||void 0===a?void 0:null===(i=a.anchorNode)||void 0===i?void 0:null===(n=i.parentElement)||void 0===n?void 0:n.closest("[data-page-index]"),r=o.clientHeight,c=o.clientWidth,d=o.getBoundingClientRect();return l&&d?{top:(l.top-d.top)/r*100,left:((null==l?void 0:l.left)-d.left)/c*100}:null}}}]);