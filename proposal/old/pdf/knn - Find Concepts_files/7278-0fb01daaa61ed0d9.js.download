"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7278],{87278:function(e,t,n){n.d(t,{C:function(){return S},Z:function(){return m}});var a=n(35944),i=n(67294),s=n(9669),o=n.n(s),l=n(91444),r=n(46193);class c{async getCopilotSettings(e){return(await o().get("".concat("/api/genius/settings","?entity_type=").concat(e))).data}}let u=new c;var d=n(19233);let g=()=>({message_uuid:(0,d.e)(),position:"RIGHT",created_at:new Date().toISOString(),parent_message_uuid:null,attachment:null,attachment_uuid:null,is_feedback_positive:null,confident_score:null});var p=n(17213),y=n(94853),_=n(11511),f=n(75781),h=n(56559),w=n(51048);let S=(0,i.createContext)({copilotUIState:null,conversationId:null,messages:[],totalMessages:0,entityType:null,featuresEnabled:[],entityHasPdf:!1,entityFullSlug:null,title:"",copilotSize:"LARGE",variant:"DEFAULT",showLoginPrompt:!1,pinnedEntities:[],showNewMessageAlert:!1,copilotContextId:"",citationHighlights:[],followupQuestions:null,fetchingFollowUpQuestions:!1,userMessage:null,questionDrawerOpen:!1,scopeVisible:!1,globalScope:!1,libraryScope:null,scopeCollections:null,fetchingGenericQuestions:!1,genericQuestions:[],scopeSelectedCollections:[],copilotDisabled:!1,fetchingCopilotSettings:!1,showCopilotSettings:!1,openCopilotSettings:!1,updateScopeSelectedCollections:()=>{},changePinnedEntities:()=>{},sendMessage:async()=>{},updateFeedback:()=>{},toggleCopilotSize:async()=>{},handleCitationHighlights:()=>{},changeShowNewMessageAlert:()=>{},changeQuestionDrawerOpen:()=>{},changeScopeVisible:()=>{},changeCopilotUIState:()=>{},fetchMessages:()=>{},changeGlobalScope:()=>{},changeOpenCopilotSetting:()=>{},changeShowLoginPrompt:()=>{},changeLibraryScope:()=>{},createConversation:async()=>null,getEntityConversation:async()=>null});var m=e=>{let{children:t,copilotSize:n,featuresEnabled:s,entityFullSlug:c,entityType:d,entityHasPdf:m,variant:v,title:C,getEntityConversation:E,afterToggleCopilotSize:b,afterCheckCopilotLimit:I,beforeSendNewMessage:A,createEntityConversation:k,afterSendNewMessage:L,afterCreateConversation:M,beforeResetCopilot:O,afterResetCopilot:G,beforeCreateConversation:N}=e,{featureFlags:F}=(0,i.useContext)(f.I),{isLoggedIn:T}=(0,i.useContext)(h.Vo),{activeCopilotGPTModel:R,fetchCopilotLimit:q,userCurrentPlan:Q,gptModels:Z,currentGPTModel:D,resetCopilotLimit:H}=(0,i.useContext)(w.L),[P,U]=(0,i.useState)(null),[B,x]=(0,i.useState)([]),[V,J]=(0,i.useState)(0),[j,z]=(0,i.useState)(null),[Y,W]=(0,i.useState)(!1),[$,K]=(0,i.useState)(null),[X,ee]=(0,i.useState)(!1),[et,en]=(0,i.useState)([]),[ea,ei]=(0,i.useState)(!1),[es,eo]=(0,i.useState)(null),[el,er]=(0,i.useState)([]),[ec,eu]=(0,i.useState)(null),[ed,eg]=(0,i.useState)(!1),[ep,ey]=(0,i.useState)([]),[e_,ef]=(0,i.useState)(!0),[eh,ew]=(0,i.useState)([]),[eS,em]=(0,i.useState)(null),[ev,eC]=(0,i.useState)(!1),[eE,eb]=(0,i.useState)(n),[eI,eA]=(0,i.useState)(!1),[ek,eL]=(0,i.useState)(!1),[eM,eO]=(0,i.useState)(!1),[eG,eN]=(0,i.useState)(!1),[eF,eT]=(0,i.useState)(!1),eR=(0,i.useRef)(),eq=(0,i.useRef)(!1),eQ=(0,i.useId)(),eZ=s.includes("CITATION"),eD=s.includes("SCOPE"),eH=async()=>{await (null==O?void 0:O()),x([]),U(null),ey([]),eu(null),eg(!1),ei(!1),er([]),eA(!1),await (null==G?void 0:G())},eP=async e=>{eb(t=>e||("LARGE"===t?"SMALL":"LARGE")),await b(e||("LARGE"===eE?"SMALL":"LARGE"))},eU=()=>{let e=document.getElementById("".concat(eQ,"__input"));e&&(e.value="")},eB=async()=>{try{ef(!0);let e=await r.Z.getGenericQuestion({entity_type:d});ew(e.data)}catch(e){console.log("getGenericQuestion",e)}finally{ef(!1)}},ex=async()=>{try{await eH(),em("FETCHING_CONVERSATION");let e=await eJ();if(!e)return;em("FETCHING_MESSAGES");let{data:t,total:n}=await r.Z.getMessage(e.conversation_uuid);x([...t]),J(n),em(null)}catch(e){console.error(e),em("INIT_ERROR")}},eV=async()=>{await (null==N?void 0:N());let e=await k();if(!(null==e?void 0:e.conversation_uuid))throw Error("Conversation UUID missing");return U(e),eD&&await e0(e),await M(),e},eJ=async()=>{let e=await E();return(U(e),null==e?void 0:e.conversation_uuid)?(e.conversation_uuid&&eD&&await e1(e),e):(await eH(),em(null),null)},ej=async e=>{if(null==P?void 0:P.conversation_uuid){em("FETCHING_PAGINATED_MESSAGES");try{let t=await r.Z.getMessage(P.conversation_uuid,e);t.data&&x(e=>[...t.data,...e])}catch(e){console.log("error while fetching messages",e)}finally{em(null)}}},ez=()=>{var e;let t="".concat(eQ,"__message_container");null===(e=document.getElementById(t))||void 0===e||e.scroll({top:0})},eY=()=>{let e=(0,p.mL)(eQ);if(eA(!e),e){if("PAPER"===d){(0,p.Vr)(eQ);return}(0,p.hO)(eQ)}},eW=async(e,t)=>{if(eq.current=!0,!e)return;null==A||A();let{conversationQuestionInfo:n,conversationQuestionType:a,conversationQuestionLocation:i=null,modifyMessageUuid:s=null}={...t};eU(),K(null),ee(!1),eA(!1),ez();try{var u;em("SENDING_MESSAGE");let o=(0,_.G)(),l=(null===(u=e.attachment)||void 0===u?void 0:u.attachment_uuid)||null,p=null;"MODIFY"===e.user_prompt_type&&(p=s);let f={...g(),...e,parent_message_uuid:p};z(f);let h=P;(null==h?void 0:h.conversation_uuid)||(h=await eV(),em("SENDING_MESSAGE"));let w={parent_message_uuid:p,attachment_uuid:l,language:o,full_slug:c,entity_type:d,conversation_question_info:n,conversation_question_type:a,conversation_question_location:i,model_variant:R,...e},S=(0,y.J8)(Z,R);S&&(w.settings=S);let m=new AbortController;eR.current=m;let v=await r.Z.createMessage(h.conversation_uuid,w,m.signal);f={...f,...v.user_input};let C=v.genius_output;eK(C,h),z(null),x(e=>[...e,{...f},C]),setTimeout(eY,50),await L({citationEnabled:eZ,globalScope:ea,libraryScope:ec,copilotResponse:C,messageData:e,newMessageOptions:t,parentMessageId:p,userCurrentPlan:Q,copilotSettings:S}),em(null)}catch(e){o().isCancel(e)||(em("SENDING_MESSAGE_ERROR"),l.Am.error("Something went wrong. Please try again."),eL(ev),console.log("sendMessage",e))}finally{eq.current=!1}},e$=async()=>{try{let e=await q();if(e&&e.has_access)return!1;eL(!0);let{showLoginPrompt:t}=await I();eC(t)}catch(e){console.error("checkCopilotLimit",e)}return!0},eK=async(e,t)=>{if(!(s.includes("MESSAGE_FOLLOWUP_QUESTION")&&F.messageFollowupQuestionEnabled&&e.generate_followup_questions&&t.conversation_uuid)){e$();return}if(W(!0),eL(!0),await e$()){W(!1);return}try{let n=(0,_.G)(),a=await r.Z.getFollowupQuestionsForMessage(t.conversation_uuid,e.message_uuid,n);K(null==a?void 0:a.data),eL(!1)}catch(e){console.log("checkCopilotLimitAndFetchFollowupQuestions",e)}finally{eL(!1),W(!1)}},eX=e=>{("keydown"!==e.type||void 0===e.key||"Escape"===e.key)&&(e.preventDefault(),e.stopPropagation(),en([]))},e0=async e=>{try{let t=await r.Z.createUpdateConversationScope(e.conversation_uuid,{is_global_scope:ea,library_scope:ec,library_scope_collection_full_slugs:el});ei(t.is_global_scope),eu(t.library_scope),eo(t.library_scope_collections.data);let n=t.library_scope_collections.data.filter(e=>e.is_selected).map(e=>e.full_slug)||[];er(n)}catch(e){console.log("createScope",e)}},e1=async e=>{let t=await r.Z.getConversationScope(e.conversation_uuid);t&&(ei(t.is_global_scope),eu(t.library_scope),eo(t.library_scope_collections.data),er(t.library_scope_collections.data.filter(e=>e.is_selected).map(e=>e.full_slug)||[]))},e9=async(e,t)=>{if(t){er(t=>{let n=[...t,e];return n.length===(null==es?void 0:es.length)?(eu("ALL"),[]):(eu("CUSTOM"),n)});return}er(t=>{if("ALL"===ec){let t=((null==es?void 0:es.map(e=>e.full_slug))||[]).filter(t=>t!==e);return eu("CUSTOM"),t}let n=t.filter(t=>t!==e);return 0===n.length?(eu(null),[]):(eu("CUSTOM"),n)})},e5=async()=>{if(!d)return;let e=null;eN(!0);try{if(!(e=await u.getCopilotSettings(d))||!e.is_show){eO(!1),eN(!0);return}eO(!0);let t=(0,y.tC)();if(!D)return;if(!t){(0,y.gw)(e),(0,y.bf)(e),eN(!1);return}let n=(0,y.wF)(e,t);(0,y.bf)(n),(0,y.gw)(n)}catch(e){console.error("getCopilotSettings",e)}finally{eN(!1)}};return(0,i.useEffect)(()=>{eq.current||ex()},[c]),(0,i.useEffect)(()=>{H(),eC(!1),eL(!1),e$().then(e=>{e||em(null)}).catch(e=>{console.log("useEffect.checkCopilotLimit",e)})},[T]),(0,i.useEffect)(()=>(document.addEventListener("keydown",eX),()=>{document.removeEventListener("keydown",eX)}),[et]),(0,i.useEffect)(()=>{eB()},[d]),(0,i.useEffect)(()=>{Z.length&&e5()},[T,Z,d]),(0,i.useEffect)(()=>{eb(n)},[n]),(0,a.tZ)(S.Provider,{value:{copilotUIState:eS,conversationId:(null==P?void 0:P.conversation_uuid)||null,messages:B,totalMessages:V,entityType:d,featuresEnabled:s,entityHasPdf:m,entityFullSlug:c,title:C,copilotSize:eE,variant:v,showLoginPrompt:ev,pinnedEntities:ep,showNewMessageAlert:eI,copilotContextId:eQ,citationHighlights:et,followupQuestions:$,fetchingFollowUpQuestions:Y,userMessage:j,questionDrawerOpen:X,scopeVisible:ed,libraryScope:ec,globalScope:ea,scopeCollections:es,fetchingGenericQuestions:e_,genericQuestions:eh,scopeSelectedCollections:el,copilotDisabled:ek,fetchingCopilotSettings:eG,showCopilotSettings:eM,openCopilotSettings:eF,changePinnedEntities:e=>{ey(e)},sendMessage:eW,updateFeedback:(e,t)=>{if(!(null==P?void 0:P.conversation_uuid))return;r.Z.updateMessage(P.conversation_uuid,e,{is_feedback_positive:t});let n=B.findIndex(t=>t.message_uuid===e);x(e=>(e[n].is_feedback_positive=t,[...e]))},fetchMessages:ej,toggleCopilotSize:eP,handleCitationHighlights:e=>{en(e.map(e=>{let t=e.page_index;return{...e,pageIndex:t}}))},changeShowNewMessageAlert:eA,changeQuestionDrawerOpen:ee,changeScopeVisible:e=>{eg(e),(null==P?void 0:P.conversation_uuid)&&!e&&e0(P)},changeCopilotUIState:em,updateScopeSelectedCollections:e9,changeGlobalScope:ei,changeOpenCopilotSetting:eT,changeShowLoginPrompt:eC,changeLibraryScope:e=>{"ALL"===e?eu(e):eu(null),er([])},createConversation:eV,getEntityConversation:E},children:t})}},46193:function(e,t,n){var a=n(9669),i=n.n(a);let s="/api/genius/conversation";class o{async createConversation(e){return(await i().post("".concat(s),e,{withCredentials:!0})).data}async getPaperConversation(e){let t="".concat(s,"/paper/").concat(e);return(await i().get(t,{withCredentials:!0})).data}async getRecordConversation(e){let t="".concat(s,"/record/").concat(e);return(await i().get(t,{withCredentials:!0})).data}async getAuthorConversation(e){let t="".concat(s,"/author/").concat(e);return(await i().get(t,{withCredentials:!0})).data}async getSearchTableConversation(e){let t="".concat(s,"/search-table/").concat(e);return(await i().get(t,{withCredentials:!0})).data}async getLibraryConversation(){return(await i().get("".concat(s,"/library"))).data}async createMessage(e,t,n){let a="".concat(s,"/").concat(e,"/messages");return(await i().post(a,t,{withCredentials:!0,signal:n})).data}async getMessage(e,t){let n="".concat(s,"/").concat(e,"/messages");return(await i().get(n,{withCredentials:!0,...t?{params:{page:t}}:{}})).data}async updateMessage(e,t,n){let a="".concat(s,"/").concat(e,"/messages/").concat(t);return(await i().patch(a,n,{withCredentials:!0})).data}async getConversationQuestions(e){let t="".concat(s,"/").concat(e,"/questions");return(await i().get(t,{withCredentials:!0})).data}async createCustomQuestion(e,t){let n="".concat(s,"/").concat(e,"/custom-questions");return(await i().post(n,t,{withCredentials:!0})).data}async getGenericQuestion(e){return(await i().post("".concat(s,"/generic-questions"),e,{withCredentials:!0})).data}async getDynamicQuestionForRecord(e){let t="".concat(s,"/record/").concat(e,"/dynamic-questions"),{data:n}=await i().get(t);return n}async getConversationHistory(){return(await i().get("".concat(s,"/history"))).data}async getConversationScope(e){let t="".concat(s,"/").concat(e,"/scope");return(await i().get(t)).data}async createUpdateConversationScope(e,t){let n="".concat(s,"/").concat(e,"/scope");return(await i().post(n,t)).data}async getFollowupQuestionsForMessage(e,t,n){let a="".concat(s,"/").concat(e,"/messages/").concat(t,"/followup-questions?language=").concat(n);return(await i().get(a)).data}}let l=new o;t.Z=l},17213:function(e,t,n){n.d(t,{Vr:function(){return i},hO:function(){return a},mL:function(){return s}});let a=e=>{var t;null===(t=document.getElementById("".concat(e,"__last_message_body")))||void 0===t||t.scrollIntoView({block:"end",inline:"start"})},i=e=>{let t=document.getElementById("".concat(e,"__last_message_body")),n=document.getElementById("".concat(e,"__message_container"));n&&t&&(n.scrollTop=t.offsetTop-n.offsetTop-40)},s=e=>{let t=document.getElementById("".concat(e,"__message_container")),n=document.getElementById("".concat(e,"__last_message_header"));return!!n&&!!t&&n.getBoundingClientRect().bottom<t.clientHeight}},94853:function(e,t,n){n.d(t,{HY:function(){return p},J8:function(){return o},tC:function(){return g},j3:function(){return w},wF:function(){return d},pv:function(){return y},bf:function(){return c},gw:function(){return r},HB:function(){return _}});var a=n(95288),i=n(28508);let s=(e,t)=>{if(!e.trim())return"";let n=e.trim().replace(/(\w+)([,./"\s]*)/g,(e,t,n)=>"".concat(t).concat(n)),i=(0,a.Ht)(n);return n.split(/\s+/).slice(0,Math.min(i,t)).join(" ")},o=(e,t)=>{let n=e.find(e=>e.key===t),a=localStorage.getItem(i.Io);if(a&&n)return JSON.parse(a)[n.is_premium?"high-quality":"standard"]},l=(e,t,n)=>{switch(e.type){case"input":return{...e,data:t[n][e.key]};case"multi_select":if(!Array.isArray(e.data))return e;let a=e.data.map(a=>{var i,s;let o=null===(i=t[n][e.key])||void 0===i?void 0:i.includes(a.key);return{...a,is_selected:(null===(s=t[n][e.key])||void 0===s?void 0:s.length)?!!(o&&!a.is_locked):a.is_selected}});if(!a.find(e=>e.is_selected))return e;return{...e,data:a};case"single_select":if(!Array.isArray(e.data))return e;let i=e.data.map(a=>t[n][e.key]!==a.key?{...a,is_selected:!1}:{...a,is_selected:!a.is_locked}),s=i.some(e=>e.is_selected);return{...e,data:s?i:e.data}}},r=(e,t)=>{let n={},a={};e.settings.standard.data.forEach(e=>{n[e.key]=u(e)}),e.settings["high-quality"].data.forEach(e=>{a[e.key]=u(e)});let s={standard:n,"high-quality":a};t&&(s.standard="high-quality"===t?a:n,s["high-quality"]="high-quality"===t?a:n),localStorage.setItem(i.Io,JSON.stringify(s))},c=e=>{localStorage.setItem(i.F9,JSON.stringify(e))},u=e=>{switch(e.type){case"input":let t="string"==typeof e.data?e.data:"";if((0,a.Ht)(t)>i.nZ)return s(t,i.nZ);return t;case"multi_select":if(!Array.isArray(e.data))return null;return e.data.filter(e=>e.is_selected).map(e=>e.key);case"single_select":if(!Array.isArray(e.data))return null;return e.data.filter(e=>e.is_selected).map(e=>e.key)[0]}},d=(e,t)=>{let n={...e};return Object.keys(e.settings).forEach(a=>{let i=e.settings[a];n.settings[a].data=i.data.map(e=>l(e,t,a))}),n},g=()=>{let e=localStorage.getItem(i.Io);if(e)return JSON.parse(e)},p=()=>{let e=localStorage.getItem(i.F9);if(e)return JSON.parse(e)},y=()=>{let e=document.querySelector("[data-copilot-setting-close-button=true]");e&&e.click()},_=e=>{if(e){for(let t in e)Array.isArray(e[t])&&(e[t]=e[t].join(", "));return e}},f=(e,t)=>"".concat(e,": **").concat(t,"**"),h=e=>{switch(e.type){case"input":let t="string"==typeof e.data?e.data:"";if((0,a.Ht)(t)>i.nZ)return f(e.name,s(t,i.nZ));return f(e.name,t);case"multi_select":if(!Array.isArray(e.data))return null;return f(e.name,e.data.filter(e=>e.is_selected).map(e=>e.name));case"single_select":if(!Array.isArray(e.data))return null;return f(e.name,e.data.filter(e=>e.is_selected).map(e=>e.name)[0])}},w=(e,t,n)=>{let a=t.find(e=>e.key===n),i={};return e.settings[(null==a?void 0:a.is_premium)?"high-quality":"standard"].data.forEach(e=>{i[e.key]=h(e)}),"Modify the response with:\n\n"+Object.values(i).join("\n\n")}},11511:function(e,t,n){n.d(t,{G:function(){return i}});var a=n(28508);let i=()=>localStorage.getItem(a.Dy)||a.k$},19233:function(e,t,n){n.d(t,{e:function(){return i}});var a=n(25934);let i=()=>(0,a.Z)()}}]);